<!DOCTYPE html>
<html lang="zh-CN"><meta charset="utf-8">
<meta name="HandheldFriendly" content="True">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="referrer" content="no-referrer">
<meta name="renderer" content="webkit">
<meta name="force-rendering" content="webkit">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="no-transform">
<meta name="format-detection" content="telephone=no,email=no,address=no">
<meta name="generator" content="Hugo 0.70.0" />


<title>单机 Prometheus 监控多集群方案 - Bowser</title>


<link rel="stylesheet" href="/css/style.css">

<link href="https://fonts.googleapis.com/css?family=Noto+Serif+SC:400,700&display=swap&subset=chinese-simplified" rel="stylesheet" />
<link rel="canonical" href="https://bowser1704.github.io/blog/20200701-%E5%8D%95%E6%9C%BA-prometheus-%E7%9B%91%E6%8E%A7%E5%A4%9A%E9%9B%86%E7%BE%A4%E6%96%B9%E6%A1%88/">
<link rel="shortcut icon" href="/favicon.jpg">

<meta itemprop="name" content="单机 Prometheus 监控多集群方案">
<meta itemprop="description" content="初始化：安装各种组件 Prometheus 和 Alertmanager 的安装都在官网 下载压缩包，手动下载下来解压。 # -C 指定目的目录 # * 代表版本，需要下载正确的系统版本。 tar xf prometheus-*.*.*.linux-amd64.tar.gz -C /opt/ tar xf alertmanager-*.*.*.linux-amd64.tar.gz">
<meta itemprop="datePublished" content="2020-07-01T22:21:01&#43;08:00" />
<meta itemprop="dateModified" content="2020-07-01T22:21:01&#43;08:00" />
<meta itemprop="wordCount" content="3302">



<meta itemprop="keywords" content="prometheus,monitoring,k3s," />
<meta property="og:title" content="单机 Prometheus 监控多集群方案" />
<meta property="og:description" content="初始化：安装各种组件 Prometheus 和 Alertmanager 的安装都在官网 下载压缩包，手动下载下来解压。 # -C 指定目的目录 # * 代表版本，需要下载正确的系统版本。 tar xf prometheus-*.*.*.linux-amd64.tar.gz -C /opt/ tar xf alertmanager-*.*.*.linux-amd64.tar.gz" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bowser1704.github.io/blog/20200701-%E5%8D%95%E6%9C%BA-prometheus-%E7%9B%91%E6%8E%A7%E5%A4%9A%E9%9B%86%E7%BE%A4%E6%96%B9%E6%A1%88/" />
<meta property="article:published_time" content="2020-07-01T22:21:01+08:00" />
<meta property="article:modified_time" content="2020-07-01T22:21:01+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="单机 Prometheus 监控多集群方案"/>
<meta name="twitter:description" content="初始化：安装各种组件 Prometheus 和 Alertmanager 的安装都在官网 下载压缩包，手动下载下来解压。 # -C 指定目的目录 # * 代表版本，需要下载正确的系统版本。 tar xf prometheus-*.*.*.linux-amd64.tar.gz -C /opt/ tar xf alertmanager-*.*.*.linux-amd64.tar.gz"/>
<body class="font-sans">
    <div class="flex flex-col md:flex-row md:w-4/5 mx-auto py-5 min-h-screen">
<header
    class="flex flex-col relative border-black border-b-4 md:border-b-0 md:border-r-2 pb-6 mx-4 md:mx-0 md:w-1/5 md:text-right md:pr-8 bg-white md:text-center">
    <link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/vs.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js"></script>
    <div>
        <h1 id="header_logo" class="text-3xl md:my-12 mt-4 md:mb-12"><a href="https://bowser1704.github.io">Bowser</a></h1>
        <p class="font-thin italic">There is no dark side of the Moon. It&#39;s all dark, really.</p>
    </div>
    <input id="menu-check" type="checkbox" class="hidden" />
    <label id="menu-label" for="menu-check"
        class="absolute right-0 text-right md:hidden  inline-block py-4 h-12 cursor-pointer mt-10 text-xl text-gray-900">
        <span class="icon close-icon">✕</span>
        <span class="icon open-icon">☰</span>
        <span class="text">MENU</span>
    </label>
    <nav id="menu" class="my-2 w-full md:flex-row-reverse hidden md:block">
        <ul class="list-none pl-0 mx-auto justify-center  max-w-xs">
            
            
            <li class="my-4 border-black text-center md:text-right border-b-2 md:border-none pb-1">
                <a class="py-4 md:border-black md:border-b-2  md:pb-1" href="/blog/">博客</a>
            </li>
            
            <li class="my-4 border-black text-center md:text-right border-b-2 md:border-none pb-1">
                <a class="py-4 md:border-black md:border-b-2  md:pb-1" href="/note/">笔记</a>
            </li>
            
            <li class="my-4 border-black text-center md:text-right border-b-2 md:border-none pb-1">
                <a class="py-4 md:border-black md:border-b-2  md:pb-1" href="/about/">关于</a>
            </li>
            
        </ul>
    </nav>
</header>
<main class="flex-1 p-4 ">
<article itemscope itemtype="http://schema.org/Article" class="max-w-3xl mx-auto leading-relaxed">
    <header class="flex flex-col meta">
<div class="flex flex-col md:flex-row justify-between ">
    
    <ul class="flex justify-end text-gray-800" itemprop="articleSection">
        
        <li class="pl-2 pr-0 md:pl-0 md:pr-2">
            <a href="/categories/cloud-native" rel="category">cloud-native</a>
        </li>
        
    </ul>
    
    
    <ul class="flex justify-end text-gray-700">
        
        <li itemprop="keywords" class="pl-2 md:pl-4">
            <a href="https://bowser1704.github.io/tags/prometheus/">#prometheus</a>
        </li>
        
        <li itemprop="keywords" class="pl-2 md:pl-4">
            <a href="https://bowser1704.github.io/tags/monitoring/">#monitoring</a>
        </li>
        
        <li itemprop="keywords" class="pl-2 md:pl-4">
            <a href="https://bowser1704.github.io/tags/k3s/">#k3s</a>
        </li>
        
    </ul>
    
</div>
<h1 itemprop="name" class="text-center text-4xl my-4 md:my-6">单机 Prometheus 监控多集群方案</h1>
        
        <h3 class="text-center text-2xl">
            
            <span itemprop="author" itemscope itemtype="http://schema.org/Person">
                <span itemprop="name">Bowser</span>
                
                
                 / 
                <span itemprop="datePublished"
                    content="2020-07-01">2020-07-01</span>
                
        </h3>
        
    </header>
    <hr class="block my-10 mx-auto max-w-xs h-px border-t border-black">
    <div itemprop="articleBody" class="content markdown">
        <h2 id="初始化安装各种组件">初始化：安装各种组件</h2>
<p>Prometheus 和 Alertmanager 的安装都在<a href="https://prometheus.io/download/">官网</a> 下载压缩包，手动下载下来解压。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># -C 指定目的目录</span>
<span style="color:#75715e"># * 代表版本，需要下载正确的系统版本。</span>
tar xf prometheus-*.*.*.linux-amd64.tar.gz -C /opt/
tar xf alertmanager-*.*.*.linux-amd64.tar.gz -C /opt/
</code></pre></div><p>安装之后使用 systemd 来管理这几个服务。手写 service 放到 systemd 文件夹下面，我的目标是 <code>/usr/lib/systemd/system/</code> 。</p>
<p>prometheus 可以热加载配置文件，如果需要通过 web API 重启，必须要加参数 <code>--web.enable-lifecycle</code>，不安全，不推荐这么做。我们使用 systemd 管理 service，可以直接用 restart 命令重启。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-service" data-lang="service"><span style="color:#66d9ef">[Unit]</span>
<span style="color:#a6e22e">Description</span><span style="color:#f92672">=</span><span style="color:#e6db74">Prometheus Server</span>
<span style="color:#a6e22e">Wants</span><span style="color:#f92672">=</span><span style="color:#e6db74">network-online.target</span>
<span style="color:#a6e22e">After</span><span style="color:#f92672">=</span><span style="color:#e6db74">network-online.target</span>

<span style="color:#66d9ef">[Service]</span>
<span style="color:#a6e22e">Type</span><span style="color:#f92672">=</span><span style="color:#e6db74">simple</span>
<span style="color:#a6e22e">ExecStartPre</span><span style="color:#f92672">=</span><span style="color:#e6db74">/opt/prometheus/promtool check config /opt/prometheus/config.yaml</span>
<span style="color:#a6e22e">ExecStart</span><span style="color:#f92672">=</span><span style="color:#e6db74">/opt/prometheus/prometheus </span>\
<span style="color:#e6db74">  --config.file /opt/prometheus/config.yaml</span>

<span style="color:#66d9ef">[Install]</span>
<span style="color:#a6e22e">WantedBy</span><span style="color:#f92672">=</span><span style="color:#e6db74">multi-user.target</span>
</code></pre></div><p>alertmanager</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-service" data-lang="service"><span style="color:#66d9ef">[Unit]</span>
<span style="color:#a6e22e">Description</span><span style="color:#f92672">=</span><span style="color:#e6db74">Alertmanager Server</span>
<span style="color:#a6e22e">Wants</span><span style="color:#f92672">=</span><span style="color:#e6db74">network-online.target</span>
<span style="color:#a6e22e">After</span><span style="color:#f92672">=</span><span style="color:#e6db74">network-online.target</span>

<span style="color:#66d9ef">[Service]</span>
<span style="color:#a6e22e">Type</span><span style="color:#f92672">=</span><span style="color:#e6db74">simple</span>
<span style="color:#a6e22e">ExecStartPre</span><span style="color:#f92672">=</span><span style="color:#e6db74">/opt/alertmanager/amtool check-config /opt/alertmanager/config.yaml</span>
<span style="color:#a6e22e">ExecStart</span><span style="color:#f92672">=</span><span style="color:#e6db74">/opt/alertmanager/altermanager </span>\
<span style="color:#e6db74">  --config.file=/opt/alertmanager/config.yaml </span>\
<span style="color:#e6db74">  --log.level=debug </span>\
<span style="color:#e6db74">  --cluster.listen-address=&#34;&#34;</span>

<span style="color:#66d9ef">[Install]</span>
<span style="color:#a6e22e">WantedBy</span><span style="color:#f92672">=</span><span style="color:#e6db74">multi-user.target</span>
</code></pre></div><p>安装 node-exporter 和 kube-state-metrics。</p>
<blockquote>
<p>在 k3s 中我使用 helmchart 安装，但是这个 CRD 有一些问题，可以更换到 <a href="https://github.com/fluxcd/helm-operator">helm-operator</a>。</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: helm.cattle.io/v1
<span style="color:#66d9ef">kind</span>: HelmChart
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: prometheus-node-exporter
  <span style="color:#66d9ef">namespace</span>: kube-system
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">helmVersion</span>: v3
  <span style="color:#66d9ef">chart</span>: prometheus-node-exporter
  <span style="color:#66d9ef">targetNamespace</span>: monitoring
  <span style="color:#66d9ef">repo</span>: https://apphub.aliyuncs.com
---
<span style="color:#66d9ef">apiVersion</span>: helm.cattle.io/v1
<span style="color:#66d9ef">kind</span>: HelmChart
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: kube-state-metrics
  <span style="color:#66d9ef">namespace</span>: kube-system
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">helmVersion</span>: v3
  <span style="color:#66d9ef">chart</span>: kube-state-metrics
  <span style="color:#66d9ef">targetNamespace</span>: monitoring
  <span style="color:#66d9ef">repo</span>: https://apphub.aliyuncs.com
</code></pre></div><p>安装两个 exporter 之后。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>root@bowser1704 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get svc -n monitoring</span>
NAME                       TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>    AGE
kube-state-metrics         ClusterIP   10.43.204.99    &lt;none&gt;        8080/TCP   19h
prometheus-node-exporter   ClusterIP   10.43.222.110   &lt;none&gt;        9100/TCP   39h
</code></pre></div><h2 id="单机监控中心监控多集群">单机监控中心监控多集群</h2>
<p>由标题，想要单机 prometheus 监控多个集群，不考虑单机压力问题，prometheus 配置和 exportor 的安装需要考虑两个问题：</p>
<ol>
<li>prometheus 通过公网访问集群的 metrics。</li>
<li>不使用 <a href="https://prometheus.io/docs/prometheus/latest/federation/#federation">prometheus federation</a> 或者 <a href="https://thanos.io/">thanos</a> 采集多集群的信息。</li>
</ol>
<h3 id="1-公网访问集群的-metrics">1. 公网访问集群的 metrics</h3>
<p>集群内部已经自建了一些 metrics 指标，这种指标可以直接通过它们暴露的 API 访问，例如 kubelet metrics，cAdvisor，API server&hellip;.。也可以通过 API server 提供的 proxy 访问。无论是怎么访问，从集群外部访问集群内部都需要手动配置 Authorization 可以直接通过 Bearer Token，也可以通过账号和密码。这里使用 token。</p>
<p>首先使用 <a href="https://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/">rbac</a> 创建一个 serviceaccount，并且创建 clusterrole，和做 clusterbinding。</p>
<p>可以参考我的 <a href="https://gist.github.com/Bowser1704/63d982782a3a8645316669d3100d8fc1">gist</a>。</p>
<blockquote>
<p>gist 中的 sa 并不能直接使用，需要后面进行二次修改，否则没有权限访问。</p>
<p>使用 clusterrole 需要访问集群所有信息，不考虑某个 namespace。</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 假设创建的 serviceaccount 是 monitoring 下的 prometheus</span>
kubectl get sa prometheus -n monitoring -o yaml

<span style="color:#75715e"># secret 的名字是上面获取的</span>
kubectl describe secret prometheus-token-cw4pd -n monitoring
</code></pre></div><h4 id="11-使用原生-api-访问内建指标">1.1 使用原生 API 访问内建指标</h4>
<blockquote>
<p>因为需要使用 https 但是证书是自签的，所以需要自己拿 ca.crt 下来，但是为了方便直接 disable validate certificates 了。</p>
</blockquote>
<ul>
<li>
<p>kubelet</p>
<p>Kubelet 监听于 10250 端口，暴露的 API 为 https://public-ip:10250/metircs，需要给 sa 的 clusterrole 设置一定的权限从而可以访问这个 API。我们使用上面创建的 sa，并且这个 sa 的 role 没有什么权限，假设只有一个 pod get 的权限，访问 API，结果是：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-http" data-lang="http"><span style="color:#960050;background-color:#1e0010">Forbidden (user=system:serviceaccount:monitoring:prometheus, verb=get, resource=nodes, subresource=metrics)
</span></code></pre></div><p>说明这个 API 需要的权限是</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">- <span style="color:#66d9ef">apiGroups</span>:
  - <span style="color:#e6db74">&#34;&#34;</span>
  <span style="color:#66d9ef">resources</span>:
  - nodes
  - nodes/metrics
  <span style="color:#66d9ef">verbs</span>:
  - get
</code></pre></div><p>在我们的 ClusterRole 里面加上这个权限。然后就可以拿到数据了，因为 http 的<a href="https://zh.wikipedia.org/wiki/%E5%88%86%E5%9D%97%E4%BC%A0%E8%BE%93%E7%BC%96%E7%A0%81">分块传输编码</a>，以及数据量很大，需要等待较长一段时间。</p>
<p>而在 prometheus.yml 里面的设置为。</p>
<blockquote>
<p>最下面的 relabel_configs 是把自带的 label 全都拿过来。</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#75715e"># 我们的场景需要设置两个 tls_config 和 bearer_token。</span>
- <span style="color:#66d9ef">job_name</span>: <span style="color:#e6db74">&#39;kubelet&#39;</span>
    <span style="color:#66d9ef">scheme</span>: https
    <span style="color:#66d9ef">tls_config</span>:
    <span style="color:#66d9ef">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
    <span style="color:#66d9ef">bearer_token_file</span>: /var/run/secrets/kubernetes.io/serviceaccount/token
    <span style="color:#66d9ef">static_configs</span>:
    - <span style="color:#66d9ef">target</span>:
    - public-ip:<span style="color:#ae81ff">10250</span>
    <span style="color:#66d9ef">relabel_configs</span>:
    - <span style="color:#66d9ef">action</span>: labelmap
    <span style="color:#66d9ef">regex</span>: __meta_kubernetes_node_label_(.+)
</code></pre></div></li>
<li>
<p>cAdvisor</p>
<p>由于高版本的 cAdvisor 合并到了 kubelet 里面，并且经过实践权限不需要修改，所以可以可以直接添加 prometheus job 就可以了。暴露的 API 为 https://public-ip:10250/metircs/cadvisor。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">- <span style="color:#66d9ef">job_name</span>: <span style="color:#e6db74">&#39;cAdvisor&#39;</span>
    <span style="color:#66d9ef">scheme</span>: https
    <span style="color:#66d9ef">tls_config</span>:
    <span style="color:#66d9ef">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
    <span style="color:#66d9ef">bearer_token_file</span>: /var/run/secrets/kubernetes.io/serviceaccount/token
    <span style="color:#66d9ef">static_configs</span>:
    - <span style="color:#66d9ef">target</span>:
    - public-ip:<span style="color:#ae81ff">10250</span>
    <span style="color:#66d9ef">relabel_configs</span>:
    - <span style="color:#66d9ef">action</span>: labelmap
    <span style="color:#66d9ef">regex</span>: __meta_kubernetes_node_label_(.+)
    - <span style="color:#66d9ef">source_labels</span>: [__meta_kubernetes_node_name]
    <span style="color:#66d9ef">regex</span>: (.+)
    <span style="color:#66d9ef">target_label</span>: __metrics_path__
    <span style="color:#66d9ef">replacement</span>: metrics/cadvisor
</code></pre></div><blockquote>
<p>最下面的 relabel_configs 是把内建的  <code>__metrics_path__</code> 修改为 metircs/cadvisor 默认为 metrics。</p>
</blockquote>
</li>
<li>
<p>&hellip;&hellip;</p>
</li>
</ul>
<h4 id="12-使用-api-server-代理访问到内建指标">1.2 使用 API server 代理访问到内建指标</h4>
<p>根据 kubernetes 的架构，我们是通过 API server 操纵访问集群内的所有 API 对象的，并且我们也可以通过 API server 代理到我们的 service，pod 从而达到外网访问集群内部资源的效果。</p>
<p>这里还要介绍一个 prometheus config <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config">kubernetes_sd_config</a>，请参考文档详细配置信息。</p>
<blockquote>
<p>Kubernetes SD configurations allow retrieving scrape targets from <a href="https://kubernetes.io/">Kubernetes&rsquo;</a> REST API and always staying synchronized with the cluster state.</p>
</blockquote>
<p>也就是说设置 kubernetes_sd_config 可以帮助我们自动发现需要监控的指标，可以根据集群的状态变化，例如你加了一个 node 他可能多了几个指标，这个时候就不需要我们手动去设置了，也就是实现了 service discovery。</p>
<ul>
<li>
<p>kubelet</p>
<p>账号依然是 1.1 中加了权限后的账号。token 还是那个 token， 证书可选。</p>
<p>下面是 config。我在 relabel_configs 主要做了几点配置：</p>
<ol>
<li>
<p>把 discover 发现的 pod ip，修改为 API server 暴露的地址 / master node public ip。</p>
<blockquote>
<p>prometheus 找到并且使用的都是 pod ip / endpoints。</p>
</blockquote>
</li>
<li>
<p>根据每个 node 的名字构建 metrics path，因为 kubelet metrics 每个 node 都有一个，所以需要采集多个 node 的 metircs，利用 kubernetes_sd_config 可以自动发现，不需要手动填写。</p>
</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">- <span style="color:#66d9ef">job_name</span>: stage-cadvisor
  <span style="color:#66d9ef">honor_timestamps</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#66d9ef">scrape_interval</span>: 15s
  <span style="color:#66d9ef">scrape_timeout</span>: 15s
  <span style="color:#66d9ef">metrics_path</span>: /metrics
  <span style="color:#66d9ef">scheme</span>: https
  <span style="color:#66d9ef">kubernetes_sd_configs</span>:
  - <span style="color:#66d9ef">api_server</span>: https://:<span style="color:#ae81ff">6443</span>
    <span style="color:#66d9ef">role</span>: node
    <span style="color:#66d9ef">bearer_token_file</span>: /opt/prometheus/serviceaccount/stage/token
    <span style="color:#66d9ef">tls_config</span>:
      <span style="color:#66d9ef">ca_file</span>: /opt/prometheus/serviceaccount/stage/ca.crt
      <span style="color:#66d9ef">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#66d9ef">bearer_token_file</span>: /opt/prometheus/serviceaccount/stage/token
  <span style="color:#66d9ef">tls_config</span>:
    <span style="color:#66d9ef">ca_file</span>: /opt/prometheus/serviceaccount/stage/ca.crt
    <span style="color:#66d9ef">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#66d9ef">relabel_configs</span>:
  - <span style="color:#66d9ef">separator</span>: ;
    <span style="color:#66d9ef">regex</span>: __meta_kubernetes_node_label_(.+)
    <span style="color:#66d9ef">replacement</span>: $<span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">action</span>: labelmap
  - <span style="color:#66d9ef">separator</span>: ;
    <span style="color:#66d9ef">regex</span>: (.<span style="color:#75715e">*)</span>
    <span style="color:#66d9ef">target_label</span>: __address__
    <span style="color:#66d9ef">replacement</span>: public-ip:<span style="color:#ae81ff">6443</span>
    <span style="color:#66d9ef">action</span>: replace
  - <span style="color:#66d9ef">source_labels</span>: [__meta_kubernetes_node_name]
    <span style="color:#66d9ef">separator</span>: ;
    <span style="color:#66d9ef">regex</span>: (.+)
    <span style="color:#66d9ef">target_label</span>: __metrics_path__
    <span style="color:#66d9ef">replacement</span>: /api/v1/nodes/${<span style="color:#ae81ff">1</span>}/proxy/metrics
    <span style="color:#66d9ef">action</span>: replace
</code></pre></div></li>
<li>
<p>cAdvisor</p>
<p>cAdivisor 和 kubelet 类似，只需要在 metrics path 后面加一个 cadvisor 就可以了。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">- <span style="color:#66d9ef">job_name</span>: stage-cadvisor
  <span style="color:#66d9ef">honor_timestamps</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#66d9ef">scrape_interval</span>: 15s
  <span style="color:#66d9ef">scrape_timeout</span>: 15s
  <span style="color:#66d9ef">metrics_path</span>: /metrics
  <span style="color:#66d9ef">scheme</span>: https
  <span style="color:#66d9ef">kubernetes_sd_configs</span>:
  - <span style="color:#66d9ef">api_server</span>: https://public-ip:<span style="color:#ae81ff">6443</span>
    <span style="color:#66d9ef">role</span>: node
    <span style="color:#66d9ef">bearer_token_file</span>: /opt/prometheus/serviceaccount/stage/token
    <span style="color:#66d9ef">tls_config</span>:
      <span style="color:#66d9ef">ca_file</span>: /opt/prometheus/serviceaccount/stage/ca.crt
      <span style="color:#66d9ef">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#66d9ef">bearer_token_file</span>: /opt/prometheus/serviceaccount/stage/token
  <span style="color:#66d9ef">tls_config</span>:
    <span style="color:#66d9ef">ca_file</span>: /opt/prometheus/serviceaccount/stage/ca.crt
    <span style="color:#66d9ef">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#66d9ef">relabel_configs</span>:
  - <span style="color:#66d9ef">separator</span>: ;
    <span style="color:#66d9ef">regex</span>: __meta_kubernetes_node_label_(.+)
    <span style="color:#66d9ef">replacement</span>: $<span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">action</span>: labelmap
  - <span style="color:#66d9ef">separator</span>: ;
    <span style="color:#66d9ef">regex</span>: (.<span style="color:#75715e">*)</span>
    <span style="color:#66d9ef">target_label</span>: __address__
    <span style="color:#66d9ef">replacement</span>: public-ip:<span style="color:#ae81ff">6443</span>
    <span style="color:#66d9ef">action</span>: replace
  - <span style="color:#66d9ef">source_labels</span>: [__meta_kubernetes_node_name]
    <span style="color:#66d9ef">separator</span>: ;
    <span style="color:#66d9ef">regex</span>: (.+)
    <span style="color:#66d9ef">target_label</span>: __metrics_path__
    <span style="color:#66d9ef">replacement</span>: /api/v1/nodes/${<span style="color:#ae81ff">1</span>}/proxy/metrics/cadvisor
    <span style="color:#66d9ef">action</span>: replace
  - <span style="color:#66d9ef">separator</span>: ;
    <span style="color:#66d9ef">regex</span>: (.<span style="color:#75715e">*)</span>
    <span style="color:#66d9ef">target_label</span>: cluster
    <span style="color:#66d9ef">replacement</span>: stage
    <span style="color:#66d9ef">action</span>: replace
</code></pre></div></li>
<li>
<p>apiserver</p>
<p>apiserver 可以直接通过 API server 暴露的地址加上一个 metrics path 就可以了，例如 https://public-ip:6443/metrics。</p>
<p>我在 relabel_configs 主要做的配置是：</p>
<ol>
<li>把 discover 发现的 pod ip，修改为 API server 暴露的地址 / master node public ip。</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">- <span style="color:#66d9ef">job_name</span>: stage-apiservers
  <span style="color:#66d9ef">honor_timestamps</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#66d9ef">scrape_interval</span>: 15s
  <span style="color:#66d9ef">scrape_timeout</span>: 15s
  <span style="color:#66d9ef">metrics_path</span>: /metrics
  <span style="color:#66d9ef">scheme</span>: https
  <span style="color:#66d9ef">kubernetes_sd_configs</span>:
  - <span style="color:#66d9ef">api_server</span>: https://public-ip:<span style="color:#ae81ff">6443</span>
    <span style="color:#66d9ef">role</span>: endpoints
    <span style="color:#66d9ef">bearer_token_file</span>: /opt/prometheus/serviceaccount/stage/token
    <span style="color:#66d9ef">tls_config</span>:
      <span style="color:#66d9ef">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#66d9ef">bearer_token_file</span>: /opt/prometheus/serviceaccount/stage/token
  <span style="color:#66d9ef">tls_config</span>:
    <span style="color:#66d9ef">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#66d9ef">relabel_configs</span>:
  - <span style="color:#66d9ef">source_labels</span>: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
    <span style="color:#66d9ef">separator</span>: ;
    <span style="color:#66d9ef">regex</span>: default;kubernetes;https
    <span style="color:#66d9ef">replacement</span>: $<span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">action</span>: keep
  - <span style="color:#66d9ef">separator</span>: ;
    <span style="color:#66d9ef">regex</span>: (.<span style="color:#75715e">*)</span>
    <span style="color:#66d9ef">target_label</span>: __address__
    <span style="color:#66d9ef">replacement</span>: public-ip:<span style="color:#ae81ff">6443</span>
    <span style="color:#66d9ef">action</span>: replace
</code></pre></div></li>
</ul>
<h4 id="13-使用-api-server-代理访问到自建指标">1.3 使用 API server 代理访问到自建指标</h4>
<p>你可以将自建的 exporter 都部署到一个 namespace 然后根据这个 namespace 的名字抓取所有的 metrics，或者根据某个 annotation 选择，但是这样的坏处是，所有的指标都在一个 job 下面，不太美观，出了问题不能一样排查出来，所以我选择的是 node-exporter，kube-state-metrics，traefik 都分开来。</p>
<ul>
<li>
<p>Node-exporter</p>
<p>node-exporter 会根据 node 的个数自己变化，所以我们肯定需要使用 kubernetes_sd_config 来自动发现。</p>
<p>下面是 config，注意我们 kubernetes_sd_config 的 role 是 endpoints。在 relabel_configs 做的配置是</p>
<ol>
<li>
<p>匹配 __meta_kubernetes_endpoints_name 为 prometheus-node-exporter 的，实际上这里是你 node-exporter service 的 name。</p>
<blockquote>
<p>你依然可以指定 namespace，指定 annotation，但是如果确定这个已经是唯一定位到你需要的 svc 就不需要写那么多了。</p>
</blockquote>
</li>
<li>
<p>更换 metrics path</p>
<p>目标为 <code>/api/v1/namespaces/$1/services/$2:$3/proxy$4</code>。</p>
</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">- <span style="color:#66d9ef">job_name</span>: stage-node-exporter
  <span style="color:#66d9ef">honor_timestamps</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#66d9ef">scrape_interval</span>: 15s
  <span style="color:#66d9ef">scrape_timeout</span>: 15s
  <span style="color:#66d9ef">metrics_path</span>: /metrics
  <span style="color:#66d9ef">scheme</span>: https
  <span style="color:#66d9ef">kubernetes_sd_configs</span>:
  - <span style="color:#66d9ef">api_server</span>: https://public-ip:<span style="color:#ae81ff">6443</span>
    <span style="color:#66d9ef">role</span>: endpoints
    <span style="color:#66d9ef">bearer_token_file</span>: /opt/prometheus/serviceaccount/stage/token
    <span style="color:#66d9ef">tls_config</span>:
      <span style="color:#66d9ef">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#66d9ef">bearer_token_file</span>: /opt/prometheus/serviceaccount/stage/token
  <span style="color:#66d9ef">tls_config</span>:
    <span style="color:#66d9ef">insecure_skip_verify</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#66d9ef">relabel_configs</span>:
  - <span style="color:#66d9ef">source_labels</span>: [__meta_kubernetes_endpoints_name]
    <span style="color:#66d9ef">separator</span>: ;
    <span style="color:#66d9ef">regex</span>: prometheus-node-exporter
    <span style="color:#66d9ef">replacement</span>: $<span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">action</span>: keep
  - <span style="color:#66d9ef">source_labels</span>: [__meta_kubernetes_pod_annotation_prometheus_io_port]
    <span style="color:#66d9ef">separator</span>: ;
    <span style="color:#66d9ef">regex</span>: (\d+)
    <span style="color:#66d9ef">target_label</span>: __meta_kubernetes_pod_container_port_number
    <span style="color:#66d9ef">replacement</span>: $<span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">action</span>: replace
  - <span style="color:#66d9ef">source_labels</span>: [__meta_kubernetes_service_annotation_prometheus_io_path]
    <span style="color:#66d9ef">separator</span>: ;
    <span style="color:#66d9ef">regex</span>: ()
    <span style="color:#66d9ef">target_label</span>: __meta_kubernetes_service_annotation_prometheus_io_path
    <span style="color:#66d9ef">replacement</span>: /metrics
    <span style="color:#66d9ef">action</span>: replace
  - <span style="color:#66d9ef">source_labels</span>: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_pod_container_port_number, __meta_kubernetes_service_annotation_prometheus_io_path]
    <span style="color:#66d9ef">separator</span>: ;
    <span style="color:#66d9ef">regex</span>: (.+);(.+);(.+);(.+)
    <span style="color:#66d9ef">target_label</span>: __metrics_path__
    <span style="color:#66d9ef">replacement</span>: /api/v1/namespaces/$<span style="color:#ae81ff">1</span>/services/$<span style="color:#ae81ff">2</span>:$<span style="color:#ae81ff">3</span>/proxy$<span style="color:#ae81ff">4</span>
    <span style="color:#66d9ef">action</span>: replace
  - <span style="color:#66d9ef">separator</span>: ;
    <span style="color:#66d9ef">regex</span>: (.<span style="color:#75715e">*)</span>
    <span style="color:#66d9ef">target_label</span>: __address__
    <span style="color:#66d9ef">replacement</span>: public-ip:<span style="color:#ae81ff">6443</span>
    <span style="color:#66d9ef">action</span>: replace
  - <span style="color:#66d9ef">separator</span>: ;
    <span style="color:#66d9ef">regex</span>: __meta_kubernetes_service_label_(.+)
    <span style="color:#66d9ef">replacement</span>: $<span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">action</span>: labelmap
  - <span style="color:#66d9ef">source_labels</span>: [__meta_kubernetes_namespace]
    <span style="color:#66d9ef">separator</span>: ;
    <span style="color:#66d9ef">regex</span>: (.<span style="color:#75715e">*)</span>
    <span style="color:#66d9ef">target_label</span>: kubernetes_namespace
    <span style="color:#66d9ef">replacement</span>: $<span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">action</span>: replace
  - <span style="color:#66d9ef">source_labels</span>: [__meta_kubernetes_service_name]
    <span style="color:#66d9ef">separator</span>: ;
    <span style="color:#66d9ef">regex</span>: (.<span style="color:#75715e">*)</span>
    <span style="color:#66d9ef">target_label</span>: kubernetes_name
    <span style="color:#66d9ef">replacement</span>: $<span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">action</span>: replace
  - <span style="color:#66d9ef">source_labels</span>: [__meta_kubernetes_pod_node_name]
    <span style="color:#66d9ef">separator</span>: ;
    <span style="color:#66d9ef">regex</span>: (.<span style="color:#75715e">*)</span>
    <span style="color:#66d9ef">target_label</span>: instance
    <span style="color:#66d9ef">replacement</span>: $<span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">action</span>: replace
</code></pre></div></li>
</ul>
<p>其他的自建指标都与这个类似，使用 label 可以唯一找到目标就行了。</p>
<p>同时有些指标可能不需要服务发现，可能只有一个 endpoint，那我们其实可以手动写 static_config。</p>
<ul>
<li>kube-state-metrics</li>
<li>traefik</li>
<li>CoreDNS</li>
</ul>
<p>完整 config 可以参考 <a href="https://gist.github.com/Bowser1704/9ceb310cf9d0f1f605a5eeafb6ddbce4">gist</a></p>
<h3 id="2-监控多集群">2. 监控多集群</h3>
<p>由于 Prometheus 监控的单位是 job，并且一个 job 里面不能写多个 kubernetes_sd_config，但是 static_configs 里面可以有多个 target。所以说我们有两种思路：</p>
<ol>
<li>
<p>需要使用 kubernetes_sd_config 的，每个集群新建一个 job，而其他则可以使用 static_configs 并且使用 label 来区分。</p>
<p>例如：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">static_configs</span>:
  - <span style="color:#66d9ef">targets</span>:
    - stage-ip:<span style="color:#ae81ff">6443</span>
    <span style="color:#66d9ef">labels</span>:
      <span style="color:#66d9ef">cluster</span>: stage
  - <span style="color:#66d9ef">targets</span>:
     - product-ip:<span style="color:#ae81ff">6443</span>
     <span style="color:#66d9ef">labels</span>:
         <span style="color:#66d9ef">cluster</span>: product
</code></pre></div></li>
<li>
<p>每个集群都新建所有 job，这个比较简单，有了一个模版，改字段就可以了，我上面的 config 就是这样，如果是 product1 集群，这 Crtl+R 替换所有的 stage 为 product1。</p>
<blockquote>
<p>stage、product 等名字都是自己定的。</p>
</blockquote>
<p>也不需要再添加新的 label，因为 job_name 就可以作为一个 label。</p>
</li>
</ol>
<p>最后的结果也是汇总到同一个 time series 下面的。</p>
<h2 id="prometheus-operator">Prometheus Operator</h2>
<p>目前来说集群的主流监控方案，使用的都是 <a href="https://prometheus.io/">prometheus</a> 组件，并且配合 <a href="https://grafana.com/">Grafana</a> 实现可视化。而随着 <a href="https://coreos.com/blog/introducing-operators.html">Operators</a> 的提出，以及 CoreOS 首先实现的两个 Operator 其中之一是 <a href="https://coreos.com/blog/the-prometheus-operator.html">Prometheus Operator</a>，主流的部署方案也不再是原生写 yaml 文件来部署 prometheus 等软件了，而是采用 CoreOS 提供的 <a href="https://github.com/coreos/prometheus-operator">Prometheus Operator</a> 部署，另外由于 Helm 的流行，更多的人使用 Helm 来安装 Prometheus Operator 从而使得集群监控方案的部署就像普通 Linux 发行版安装一个软件时使用一条包管理器命令一样简单。</p>
<blockquote>
<p>To demonstrate the Operator concept in running code, we have two concrete examples to announce as open source projects today:</p>
<ol>
<li>The <a href="https://coreos.com/blog/introducing-the-etcd-operator.html"><em>etcd Operator</em></a> creates, configures, and manages etcd clusters. etcd is a reliable, distributed key-value store introduced by CoreOS for sustaining the most critical data in a distributed system, and is the primary configuration datastore of Kubernetes itself.</li>
<li>The <a href="https://coreos.com/blog/the-prometheus-operator.html"><em>Prometheus Operator</em></a> creates, configures, and manages Prometheus monitoring instances. Prometheus is a powerful monitoring, metrics, and alerting tool, and a Cloud Native Computing Foundation (CNCF) project supported by the CoreOS team.</li>
</ol>
<p>&mdash; CoreOS</p>
</blockquote>
<h2 id="为什么不使用原生-prometheus">为什么不使用原生 Prometheus</h2>
<p>众所周知，目前来说，k8s 对于有状态（stateful）应用的管理还是没有很好，可以说是一个痛点，所以像 databases, caches, 和 monitoring systems 这些有状态应用，手动使用 StatefulSet 来部署，不过显然是没有 Operator 来的方便。</p>
<blockquote>
<p>operater 可以看成一个特定应用的 SRE 保姆。</p>
</blockquote>
<p>并且使用 Operator 将很多复杂的配置都抽离出来了。使部署一些需要高运维的工具不再那么容易。不过我们的场景用不了 Operator。</p>

    </div>
</article>

        </main>
    </div><footer class="flex justify-center">
    <div class="copyright mx-auto my-8">
        <p>
            © 2018-2020 <a href="https://github.com/Bowser1704">Bowser1704</a> - <strong><a href="https://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC 4.0</a></strong> - <strong>Power By Hugo | Theme By hugo-w2ng</strong>
        </p>
        
    </div>
</footer>



<script src="//instant.page/3.0.0" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script></body>

</html>