<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Hugo 0.57.2" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="Bowser" />
  <meta property="og:url" content="https://bowser1704.github.io/posts/system-boot/" />
  <link rel="canonical" href="https://bowser1704.github.io/posts/system-boot/" /><link rel="shortcut icon" href="/icon.svg" type="image/x-png" /><script type="application/ld+json">
  {
      "@context" : "http://schema.org",
      "@type" : "BlogPosting",
      "mainEntityOfPage": {
           "@type": "WebPage",
           "@id": "https:\/\/bowser1704.github.io"
      },
      "articleSection" : "posts",
      "name" : "谈谈系统启动发生了什么",
      "headline" : "谈谈系统启动发生了什么",
      "description" : "0. 杂谈 首先我们知道在系统中启动叫做boot，取自Bootstrap，这里有个小故事\n Bootstrap不是鞋带的意思，应该是“鞋子背带”的意思（http:\/\/en.wiktionary.org\/wiki\/bootstrap） 在这里隐喻表示一种不需要外部帮助自己能够处理事情的情形。“pull oneself up by one\x26rsquo;s bootstraps”最初来自于《The Surprising Adventures of Baron Munchausen》这本书里的一个故事：主人公Baron Munchausen不小心掉进了一片沼泽，他通过自己的bootstraps将自己拉了出来（当然有童话神奇的色彩）。事实上在19世纪初美国就有\x26rdquo;pull oneself over a fence by one\x26rsquo;s bootstraps\x26rdquo;的语言，意思是“做荒谬不可能完成的事情”。 参考：http:\/\/en.wikipedia.org\/wiki\/Bootstrapping\n 为什么说这个故事呢，我们要启动系统，就要启动程序对吧，但是启动程序又要系统，这不就是一个死循环了吗？所以一种不需要外部帮助自己能够处理事情的情形，在当时ROM（Read only memory）的发展下，人们刚开始发明了BIOS（Basic Input\/Output System），后来又出现了UEFI全称“统一的可扩展固件接口”(Unified Extensible Firmware Interface)。\n1. 最开始是如何加载系统的 1.1 老一代的Legacy BIOS \x2b MBR 最初的启动就是按下电源键之后，电脑读取写入ROM的BIOS。BIOS开始下面几个步骤。\n 硬件自检（Power-On Self-Test）简称为 POST，如果有问题计算机会发出不同含义的蜂鸣声。（有没有很傻屌） 选择启动顺序，现在BIOS开始要运行的权利给下一个device了，但是你电脑可能有多个硬盘，也可能你会插入U盘，所以可能需要你选择一个设备。  计算机开始读取设备的第一个扇区，也就是512字节，就叫做\x26rdquo;主引导记录\x26rdquo;（Master boot record，缩写为MBR）。 但是MBR有一些问题，所以现在基本不用了。  从硬盘启动，加载系统内核相关的东西。  这里因为MBR，所以系统启动读取的是MBR内的启动程序，但是如果你一个硬盘，装了很多的系统，每次装新的系统，后面的启动代码就会覆盖前者的。   总结的话BIOS不认识设备，直接硬的来，你的MBR内写了什么，他就是什么。\n1.2 进入Linux系统之后initd  加载内核，进入\/boot下找到内核文件，加载。 开始运行初始化文件\/sbin\/init，他的作用是初始化系统环境，init就是第一个进程，pid=1 确定运行级别 加载开机启动程序 用户登录 进入login shell 打开 non-login shell  这里初略讲，详情看阮一峰的文章。",
      "inLanguage" : "en-US",
      "author" : "Bowser",
      "creator" : "Bowser",
      "publisher": "Bowser",
      "accountablePerson" : "Bowser",
      "copyrightHolder" : "Bowser",
      "copyrightYear" : "2019",
      "datePublished": "2019-08-22 16:23:18 \x2b0800 CST",
      "dateModified" : "2019-08-22 16:23:18 \x2b0800 CST",
      "url" : "https:\/\/bowser1704.github.io\/posts\/system-boot\/",
      "keywords" : [  ]
  }
</script>
<title>谈谈系统启动发生了什么 - Bowser&#39;s Blog</title>
  <meta property="og:title" content="谈谈系统启动发生了什么 - Bowser&#39;s Blog" />
  <meta property="og:type" content="article" />
  <meta name="description" content="0. 杂谈 首先我们知道在系统中启动叫做boot，取自Bootstrap，这里有个小故事
 Bootstrap不是鞋带的意思，应该是“鞋子背带”的意思（http://en.wiktionary.org/wiki/bootstrap） 在这里隐喻表示一种不需要外部帮助自己能够处理事情的情形。“pull oneself up by one&rsquo;s bootstraps”最初来自于《The Surprising Adventures of Baron Munchausen》这本书里的一个故事：主人公Baron Munchausen不小心掉进了一片沼泽，他通过自己的bootstraps将自己拉了出来（当然有童话神奇的色彩）。事实上在19世纪初美国就有&rdquo;pull oneself over a fence by one&rsquo;s bootstraps&rdquo;的语言，意思是“做荒谬不可能完成的事情”。 参考：http://en.wikipedia.org/wiki/Bootstrapping
 为什么说这个故事呢，我们要启动系统，就要启动程序对吧，但是启动程序又要系统，这不就是一个死循环了吗？所以一种不需要外部帮助自己能够处理事情的情形，在当时ROM（Read only memory）的发展下，人们刚开始发明了BIOS（Basic Input/Output System），后来又出现了UEFI全称“统一的可扩展固件接口”(Unified Extensible Firmware Interface)。
1. 最开始是如何加载系统的 1.1 老一代的Legacy BIOS &#43; MBR 最初的启动就是按下电源键之后，电脑读取写入ROM的BIOS。BIOS开始下面几个步骤。
 硬件自检（Power-On Self-Test）简称为 POST，如果有问题计算机会发出不同含义的蜂鸣声。（有没有很傻屌） 选择启动顺序，现在BIOS开始要运行的权利给下一个device了，但是你电脑可能有多个硬盘，也可能你会插入U盘，所以可能需要你选择一个设备。  计算机开始读取设备的第一个扇区，也就是512字节，就叫做&rdquo;主引导记录&rdquo;（Master boot record，缩写为MBR）。 但是MBR有一些问题，所以现在基本不用了。  从硬盘启动，加载系统内核相关的东西。  这里因为MBR，所以系统启动读取的是MBR内的启动程序，但是如果你一个硬盘，装了很多的系统，每次装新的系统，后面的启动代码就会覆盖前者的。   总结的话BIOS不认识设备，直接硬的来，你的MBR内写了什么，他就是什么。
1.2 进入Linux系统之后initd  加载内核，进入/boot下找到内核文件，加载。 开始运行初始化文件/sbin/init，他的作用是初始化系统环境，init就是第一个进程，pid=1 确定运行级别 加载开机启动程序 用户登录 进入login shell 打开 non-login shell  这里初略讲，详情看阮一峰的文章。" />

  <link rel="stylesheet" href="https://unpkg.com/flexboxgrid@6.3.1/dist/flexboxgrid.min.css" />
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/tomorrow.min.css" />
  <link rel="stylesheet" href="/css/index.css">
  <link href="/index.xml" rel="alternate" type="application/rss+xml" title="Bowser&#39;s Blog">
  
  <link href="https://fonts.googleapis.com/css?family=Arvo|Permanent+Marker" rel="stylesheet">
  
  <script>
    

    (function (undefined) { }).call('object' === typeof window && window || 'object' === typeof self && self || 'object' === typeof global && global || {});
  </script>

  
</head>

<body>
  <article class="post Chinese" id="article">
    <div class="row">
      <div class="col-xs-12 col-sm-10 col-md-8 col-sm-offset-1 col-md-offset-2 col-lg-6 col-lg-offset-3">
        <div class="site-header">
          
<header>
  <div class="signatures site-title">
    <a href="/">Bowser</a>
  </div>
</header>
<div class="row end-xs">
  
  
  <div class="lang-switch col-xs-3 col-xs-offset-9">
    <a href="/en/">English</a>
  </div>
  
  
</div>
<div class="header-line"></div>

        </div>
        <header class="post-header">
          <h1 class="post-title">谈谈系统启动发生了什么</h1>
          <div class="row post-desc">
            <div class="col-xs-6">
              <time class="post-date" datetime="2019-08-22 16:23:18 CST">
                22, Aug, 2019
              </time>
            </div>
            <div class="col-xs-6">
              <div class="post-author">
                <a target="_blank" href="https://bowser1704.github.io/">@Bowser</a>
              </div>
            </div>
          </div>
        </header>

        <div class="post-content markdown-body">
          

<h3 id="0-杂谈">0. 杂谈</h3>

<p>首先我们知道在系统中启动叫做<code>boot</code>，取自Bootstrap，这里有个小故事</p>

<blockquote>
<p>Bootstrap不是鞋带的意思，应该是“鞋子背带”的意思（<a href="http://en.wiktionary.org/wiki/bootstrap）">http://en.wiktionary.org/wiki/bootstrap）</a>
在这里隐喻表示一种不需要外部帮助自己能够处理事情的情形。“pull oneself up by one&rsquo;s bootstraps”最初来自于《The Surprising Adventures of Baron Munchausen》这本书里的一个故事：主人公Baron Munchausen不小心掉进了一片沼泽，他通过自己的bootstraps将自己拉了出来（当然有童话神奇的色彩）。事实上在19世纪初美国就有&rdquo;pull oneself over a fence by one&rsquo;s bootstraps&rdquo;的语言，意思是“做荒谬不可能完成的事情”。
参考：<a href="http://en.wikipedia.org/wiki/Bootstrapping">http://en.wikipedia.org/wiki/Bootstrapping</a></p>
</blockquote>

<p>为什么说这个故事呢，我们要启动系统，就要启动程序对吧，但是启动程序又要系统，这不就是一个死循环了吗？所以<code>一种不需要外部帮助自己能够处理事情的情形</code>，在当时ROM（Read only memory）的发展下，人们刚开始发明了BIOS（Basic Input/Output System），后来又出现了<code>UEFI</code>全称“统一的可扩展固件接口”(Unified Extensible Firmware Interface)。</p>

<h3 id="1-最开始是如何加载系统的">1. 最开始是如何加载系统的</h3>

<h4 id="1-1-老一代的legacy-bios-mbr">1.1 老一代的Legacy BIOS + <code>MBR</code></h4>

<p>最初的启动就是按下电源键之后，电脑读取写入ROM的BIOS。BIOS开始下面几个步骤。</p>

<ol>
<li>硬件自检（Power-On Self-Test）简称为 POST，如果有问题计算机会发出不同含义的蜂鸣声。（有没有很傻屌）</li>
<li>选择启动顺序，现在BIOS开始要运行的权利给下一个device了，但是你电脑可能有多个硬盘，也可能你会插入U盘，所以可能需要你选择一个设备。

<ul>
<li>计算机开始读取设备的第一个扇区，也就是512字节，就叫做&rdquo;主引导记录&rdquo;（Master boot record，缩写为<code>MBR</code>）。</li>
<li>但是<code>MBR</code>有一些问题，所以现在基本不用了。</li>
</ul></li>
<li>从硬盘启动，加载系统内核相关的东西。

<ul>
<li>这里因为<code>MBR</code>，所以系统启动读取的是<code>MBR</code>内的启动程序，但是如果你一个硬盘，装了很多的系统，每次装新的系统，后面的启动代码就会覆盖前者的。</li>
</ul></li>
</ol>

<p>总结的话<code>BIOS</code>不认识设备，直接硬的来，你的<code>MBR</code>内写了什么，他就是什么。</p>

<h4 id="1-2-进入linux系统之后initd">1.2 进入Linux系统之后initd</h4>

<ol>
<li>加载内核，进入<code>/boot</code>下找到内核文件，加载。</li>
<li>开始运行初始化文件<code>/sbin/init</code>，他的作用是初始化系统环境，<code>init</code>就是第一个进程，<code>pid</code>=1</li>
<li>确定运行级别</li>
<li>加载开机启动程序</li>
<li>用户登录</li>
<li>进入login shell</li>
<li>打开 non-login shell</li>
</ol>

<p>这里初略讲，详情看阮一峰的文章。</p>

<p>阮一峰写了两篇文章对于以前的启动方式很好的讲解了</p>

<p><a href="http://www.ruanyifeng.com/blog/2013/02/booting.html">http://www.ruanyifeng.com/blog/2013/02/booting.html</a> 参考文章，作者阮一峰，对于<code>MBR</code>的详细解释</p>

<p><a href="http://www.ruanyifeng.com/blog/2013/08/linux_boot_process.html">http://www.ruanyifeng.com/blog/2013/08/linux_boot_process.html</a> 参考文章，作者阮一峰，对于<code>Linux</code>内核启动的解释。</p>

<h3 id="2-今天我们怎么加载系统">2. 今天我们怎么加载系统</h3>

<h4 id="2-1-新时代的-uefi-bios-gpt">2.1 新时代的<code>UEFI BIOS</code>+<code>GPT</code></h4>

<p><code>UEFI</code>不同于legacy BIOS的是，他认识设备，他会在<code>/boot/efi</code>寻找以<code>.efi</code>为后缀的文件，里面有一个目录<code>EFI</code>，放了各种系统的<code>efi</code>启动程序。</p>

<p>例如（不同厂商的驱动放在不同厂家的文件夹下面）</p>

<blockquote>
<p>启动windows 进入Microsoft/Boot/*.efi</p>

<p>启动<code>ubuntu</code>       进入ubuntu/*.efi</p>
</blockquote>

<p><img src="https://upload-images.jianshu.io/upload_images/4072641-4b58e0e13c209d14.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/345/format/webp" alt="efi" /></p>

<h5 id="流程">流程</h5>

<ol>
<li><p>POST，硬件自检</p></li>

<li><p><code>UEFI</code>固件加载，一系列初始化。</p></li>

<li><p>按照设置里面的顺序，读取<code>efi</code>启动项，加载硬件驱动，解析其中的分区表（GPT和MBR）。</p></li>
</ol>

<p>启动项分为两种</p>

<ul>
<li>文件启动项，即<code>UEFI</code>已经记录了启动项的地址，某个磁盘-&gt;某个分区-&gt;/<code>EFI/Boot/*.efi</code></li>
<li>设备启动项，就是磁盘，会直接去磁盘里面寻找<code>ESP</code>分区下的<code>/EFI/Boot/*.efi</code></li>
</ul>

<blockquote>
<p>随着Windows8.x，以及UEFI标准2.x，win推出了一个叫做SecureBoot的功能。开了SecureBoot之后，主板会验证即将加载的efi文件的签名，如果开发者不是受信任的开发者，就会拒绝加载。
比如CloverX64.efi就好像没有签名。</p>
</blockquote>

<p>所以在装Linux的时候我们会关闭SecureBoot，防止不被授权，无法加载efi</p>

<h5 id="磁盘分区-文件系统">磁盘分区，文件系统</h5>

<p>磁盘就是我们用的硬盘，U盘之类的，我们要对磁盘进行分区，其实不分区可以理解为只分一个区，然后每个区要进行格式化，并且选择文件系统。不同类型磁盘有不同类型的设备驱动，不同系统有不同的文件系统驱动。</p>

<ul>
<li>磁盘驱动

<ul>
<li><code>win8/10</code>含有<code>IDE/SATA/NVME</code>三种驱动</li>
<li><code>macos</code>含有<code>/SATA/NVME</code>驱动，但是10.13之前是苹果专用<code>NVME</code>驱动</li>
</ul></li>
<li>文件系统驱动

<ul>
<li><code>win10</code>含有FAT32、NTFS、exFAT、ReFS几种</li>
<li>Linux含有ext2、ext3、ext4、FAT32等</li>
<li>macOS含有FAT32、HFS+、APFS、exFAT，NTFS只读</li>
</ul></li>
</ul>

<blockquote>
<p>驱动是可以后期安装的，Paragon这个公司推出了NTFS for Mac、HFS for Windows、ExtFS for……等一套文件系统驱动。</p>
</blockquote>

<h5 id="总结">总结</h5>

<p>UEFI规范里，在GPT分区表的基础上，规定了一个EFI系统分区（EFI System Partition，ESP），ESP要格式化成FAT32，EFI启动文件要放在“/EFI&lt;厂商&gt;”文件夹下面。<strong>但是Apple比较特殊</strong></p>

<p>作为UEFI标准里，钦定的文件系统，FAT32.efi是每个主板都会带的。所有UEFI的主板都认识FAT32分区。这就是为啥非得是FAT32的。</p>

<p>至于GPT（GUID Partition Table，缩写：GPT），可以理解为新时代的<code>MBR</code>，分区表。</p>

<p>所以说</p>

<blockquote>
<p>装系统可以不用制作启动盘了，将iso文件压缩到一个FAT32分区内，<del>然后在将该分区下的<code>EFI/Boot/BOOTx64</code>添加到UEFI文件启动项</del>，直接进入UEFI引导，就可以选择这一项启动。</p>

<p>另外UEFI为了兼容MBR，是可以用的，但是Lgacy不支持GPT</p>
</blockquote>

<h4 id="2-2-systemd启动系统">2.2 Systemd启动系统</h4>

<p>init启动系统有几点不好</p>

<ul>
<li>串行启动，启动时间长</li>
<li>启动脚本复杂</li>
</ul>

<p>Systemd是用来替代init启动而生的，读作 System daemon（系统，守护进程）。</p>

<p>Systemd是一组命令，涉及到系统管理的方方面面，本来我们启动系统是用initd初始化一个pid=1的进程，然后所有进程都是他的子进程，但是现在的话我们不需要，直接启动Systemd，用它来管理系统。</p>

<p>这个时候就和上面类似了。但是我们要重点关注<code>systemd</code>命令组。这里就会体现Linux下一切皆文件的思想。</p>

<p><img src="https://ccnupp.oss-cn-shanghai.aliyuncs.com/%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E4%BB%B6.svg" alt="未命名文件" /></p>

<h3 id="参考文章">参考文章</h3>

<p><a href="https://www.ibm.com/developerworks/cn/linux/l-lpic1-101-2/index.html">https://www.ibm.com/developerworks/cn/linux/l-lpic1-101-2/index.html</a>    IBM，引导系统</p>

<p><a href="http://www.ruanyifeng.com/blog/2013/02/booting.html">http://www.ruanyifeng.com/blog/2013/02/booting.html</a> 参考文章，作者阮一峰，对于MBR的详细解释</p>

<p><a href="http://www.ruanyifeng.com/blog/2013/08/linux_boot_process.html">http://www.ruanyifeng.com/blog/2013/08/linux_boot_process.html</a> 参考文章，作者阮一峰，对于Linux内核启动的解释。</p>

<p>关于systemd使用，这里有几篇文章。</p>

<p><a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-commands.html">http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-commands.html</a>   作者：阮一峰</p>

<p><a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html">http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html</a>   作者：阮一峰</p>

<p><a href="https://wiki.archlinux.org/index.php/Systemd_(简体中文)">https://wiki.archlinux.org/index.php/Systemd_</a>    来源Archwiki</p>

<p>[TOC]</p>

        </div>

        


        
        
        <div class="post-comments">
          <div id="disqus_thread"></div>
<script>
  window.addEventListener("load", () => {
    (function() {
      
      var d = document,
        s = d.createElement("script");
      s.src = "https://Bowser.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  });
</script>
<noscript
  >Please enable JavaScript to view the
  <a href="https://disqus.com/?ref_noscript"
    >comments powered by Disqus.</a
  ></noscript
>

        </div>
        
        
        <div class="site-footer">
  
  <div class="site-footer-item">
    <a href="https://www.douban.com/people/153160581/" target="_blank">Douban</a>
  </div>
  
  <div class="site-footer-item">
    <a href="https://github.com/bowser1704" target="_blank">Github</a>
  </div>
  
  
</div>

      </div>
    </div>
  </article>

  <script src="/js/highlight.pack.js"></script>
<script src="https://unpkg.com/quicklink@0.1.1/dist/quicklink.umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@10.19.0/dist/lazyload.min.js"></script>
<script>
  var lazyImage = new LazyLoad({
    container: document.getElementById('article')
  });
</script>

<script>
  hljs.initHighlightingOnLoad();
  
  var posts = document.getElementById('posts-list');
  posts && quicklink({
    el: posts,
    priority: true,
  });
</script>

  

</body>

</html>