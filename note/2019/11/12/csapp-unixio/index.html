<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=HandheldFriendly content=True><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=referrer content=no-referrer><meta name=renderer content=webkit><meta name=force-rendering content=webkit><meta http-equiv=x-ua-compatible content="IE=edge"><meta http-equiv=cache-control content=no-transform><meta name=format-detection content="telephone=no,email=no,address=no"><meta name=generator content="Hugo 0.58.3"><title>csapp UnixIO - Bowser</title><meta itemprop=name content="csapp UnixIO"><meta itemprop=description content=csapp第十章的笔记><meta itemprop=datePublished content=2019-11-12T22:05:45&#43;08:00><meta itemprop=dateModified content=2019-11-12T22:05:45&#43;08:00><meta itemprop=wordCount content=1557><meta itemprop=keywords content=csapp,><meta property=og:title content="csapp UnixIO"><meta property=og:description content=csapp第十章的笔记><meta property=og:type content=article><meta property=og:url content=https://bowser1704.github.io/note/2019/11/12/csapp-unixio/><meta property=article:published_time content=2019-11-12T22:05:45+08:00><meta property=article:modified_time content=2019-11-12T22:05:45+08:00><meta name=twitter:card content=summary><meta name=twitter:title content="csapp UnixIO"><meta name=twitter:description content=csapp第十章的笔记><meta property=description content=csapp第十章的笔记><link rel=canonical href=https://bowser1704.github.io/note/2019/11/12/csapp-unixio/><link rel="shortcut icon" href=/favicon.jpg><style media=screen>html{font-size:100%;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%;box-sizing:border-box}*,*:before,*:after{box-sizing:inherit}body{margin:0;padding:0}button,input,select,textarea,label{margin:0;padding:0;font-family:inherit;font-size:inherit}img{max-width:100%}body{line-height:1.75}h1,h2,h3,h4,h5,h6{padding:0;margin:60px 0 30px;line-height:1.25;text-align:center}h1{font-size:32px;font-weight:400}h2{font-size:22px;font-weight:700}h3,h4,h5,h6{font-size:19px;font-weight:700;text-align:left}blockquote{margin:1em 0;padding:0 2em;border-left:3px solid #ddd}pre,code{font-size:.9em}pre code{display:block;border:1px solid #ddd;box-shadow:5px 5px 5px #eee;padding:1em;overflow-x:auto;line-height:1.75}code{background:#f9f9f9}pre code{background:0 0}ul,ol{padding:0 0 0 20px}li{margin:4px 0;padding:0}a{color:#000;text-decoration:none;padding-bottom:2px;border-bottom:1px solid}sup a{border-bottom:none}hr{display:block;height:1px;border:0;border-top:1px solid;margin:50px auto;padding:0;max-width:300px}.copyright{text-align:center}.post-nav{display:flex;justify-content:space-between;font-weight:700}.nav-next{margin-left:1em;text-align:right}.nav-prev{margin-right:1em}.comments{margin-top:20px}body{width:80%;margin:0 auto;padding:30px 0}.masthead{width:260px;padding:20px 50px 20px 10px;float:left}.main{padding:20px 100px;margin-left:260px;border-left:3px solid #000;min-height:calc(100vh - 60px)}.masthead h1{margin-top:0;margin-bottom:34px;padding:0;text-align:right;font-size:46px;line-height:58px}.masthead h1 a{border-bottom:none}.masthead .tagline{font-style:italic;text-align:right}.masthead .menu{margin-right:20px;direction:rtl}.masthead .menu a{direction:ltr}.masthead .menu ul ul{list-style:none;margin-left:10px;margin-right:10px}.masthead .menu li li::before{content:"•\00a\000a0\00a0"}.title h3.post-meta{font-family:lucida console,andale mono,stkaiti,kaiti,simkai,monospace;text-align:right;margin:0 0 20px}.title h3.post-meta .tags a{font-size:.8em}.title h3.post-meta .category a{font-size:.9em}#menu-check{display:none}#menu-label{display:none}.main .title h1{margin-top:0;margin-bottom:40px}.title h3{font-weight:400;text-align:center}.subtitle{font-size:.9em;color:#666}.footnotes{font-size:.9em}table{margin:auto;border-top:1px solid #666;border-bottom:1px solid #666}table thead th{border-bottom:1px solid #666}th,td{padding:5px}thead,tfoot,tr:nth-child(even){background:#f8f8f8}.unselectable{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}@-ms-viewport{width:device-width;}@viewport{width:device-width;}@media screen and (max-width:960px){body{width:auto;max-width:700px}.masthead{width:auto;float:none;text-align:center;margin-left:10px;margin-right:10px;padding:10px 10px 45px;border-bottom:3px solid #000}.main{width:auto;padding:20px 10px;margin-left:0;border-left:none;min-height:auto}.masthead h1{text-align:left;font-size:30px;margin-bottom:0;line-height:40px}.masthead .tagline{text-align:left;margin:0}.masthead .menu{direction:ltr;max-width:300px;margin-left:auto;margin-right:auto}.masthead #menu-label{position:absolute;top:30px;right:0}.masthead .menu ul{text-align:left;margin:0;padding:0;float:none}.masthead .menu ul ul{margin:0}.masthead .menu li{border-bottom:1px solid;list-style:none;margin:0;padding:0}.masthead .menu li:first-child{border-top:1px solid}.masthead .menu li li:last-child{border-bottom:none}.masthead .menu a{display:block;padding:15px 20px;border-bottom:none}.masthead .menu li li a{padding-left:30px}.masthead .menu li li::before{content:none}.masthead .menu li li a::before{content:"•\00a0\00a0\00a0"}#menu-label{display:inline-block;padding:0 20px;height:50px;cursor:pointer;line-height:50px;color:#333;font-size:20px;margin-top:10px}#menu-check~label .close-icon{display:none}#menu-check~label .open-icon{display:inline-block}#menu-check:checked~label .close-icon{display:inline-block}#menu-check:checked~label .open-icon{display:none}#menu-check~ul{display:none}#menu-check:checked~ul{display:block;margin-top:50px;margin-bottom:0}}@media screen and (max-width:720px){}@media screen and (max-width:480px){body{font-size:16px}h1{font-size:28px}h2{font-size:18px}h3,h4,h5,h6{font-size:16px}pre,code{font-size:12px}.masthead{padding-top:0}}.cryptedmail:after{content:attr(data-name) "@" attr(data-domain) "." attr(data-tld)}body{font-family:Meslo,Monaco,Consolas,ubuntu mono,monospace,source-han-serif-sc,source han serif sc,source han serif cn,source han serif tc,source han serif tw,source han serif,songti sc,microsoft yahei,sans-serif}code{font-family:fira code,lucida console,andale mono,stkaiti,kaiti,simkai,monospace}pre code{font-family:fira code,Consolas,lucida console,Monaco,stkaiti,kaiti,simkai,monospace}.chroma{background-color:#f8f8f8}.chroma .x{color:#000}.chroma .err{color:#a40000}.chroma .lntd{vertical-align:top;padding:0;margin:0;border:0}.chroma .lntable{border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block}.chroma .hl{display:block;width:100%;background-color:#ffc}.chroma .lnt{margin-right:.4em;padding:0 .4em}.chroma .ln{margin-right:.4em;padding:0 .4em}.chroma .k{color:#204a87;font-weight:700}.chroma .kc{color:#204a87;font-weight:700}.chroma .kd{color:#204a87;font-weight:700}.chroma .kn{color:#204a87;font-weight:700}.chroma .kp{color:#204a87;font-weight:700}.chroma .kr{color:#204a87;font-weight:700}.chroma .kt{color:#204a87;font-weight:700}.chroma .n{color:#000}.chroma .na{color:#c4a000}.chroma .nb{color:#204a87}.chroma .bp{color:#3465a4}.chroma .nc{color:#000}.chroma .no{color:#000}.chroma .nd{color:#5c35cc;font-weight:700}.chroma .ni{color:#ce5c00}.chroma .ne{color:#c00;font-weight:700}.chroma .nf{color:#000}.chroma .fm{color:#000}.chroma .nl{color:#f57900}.chroma .nn{color:#000}.chroma .nx{color:#000}.chroma .py{color:#000}.chroma .nt{color:#204a87;font-weight:700}.chroma .nv{color:#000}.chroma .vc{color:#000}.chroma .vg{color:#000}.chroma .vi{color:#000}.chroma .vm{color:#000}.chroma .l{color:#000}.chroma .ld{color:#000}.chroma .s{color:#4e9a06}.chroma .sa{color:#4e9a06}.chroma .sb{color:#4e9a06}.chroma .sc{color:#4e9a06}.chroma .dl{color:#4e9a06}.chroma .sd{color:#8f5902;font-style:italic}.chroma .s2{color:#4e9a06}.chroma .se{color:#4e9a06}.chroma .sh{color:#4e9a06}.chroma .si{color:#4e9a06}.chroma .sx{color:#4e9a06}.chroma .sr{color:#4e9a06}.chroma .s1{color:#4e9a06}.chroma .ss{color:#4e9a06}.chroma .m{color:#0000cf;font-weight:700}.chroma .mb{color:#0000cf;font-weight:700}.chroma .mf{color:#0000cf;font-weight:700}.chroma .mh{color:#0000cf;font-weight:700}.chroma .mi{color:#0000cf;font-weight:700}.chroma .il{color:#0000cf;font-weight:700}.chroma .mo{color:#0000cf;font-weight:700}.chroma .o{color:#ce5c00;font-weight:700}.chroma .ow{color:#204a87;font-weight:700}.chroma .p{color:#000;font-weight:700}.chroma .c{color:#8f5902;font-style:italic}.chroma .ch{color:#8f5902;font-style:italic}.chroma .cm{color:#8f5902;font-style:italic}.chroma .c1{color:#8f5902;font-style:italic}.chroma .cs{color:#8f5902;font-style:italic}.chroma .cp{color:#8f5902;font-style:italic}.chroma .cpf{color:#8f5902;font-style:italic}.chroma .g{color:#000}.chroma .gd{color:#a40000}.chroma .ge{color:#000;font-style:italic}.chroma .gr{color:#ef2929}.chroma .gh{color:navy;font-weight:700}.chroma .gi{color:#00a000}.chroma .go{color:#000;font-style:italic}.chroma .gp{color:#8f5902}.chroma .gs{color:#000;font-weight:700}.chroma .gu{color:purple;font-weight:700}.chroma .gt{color:#a40000;font-weight:700}.chroma .gl{color:#000;text-decoration:underline}.chroma .w{color:#f8f8f8;text-decoration:underline}div#isso-thread .avatar>svg[data-hash=a0d752802ad5]{box-shadow:0 0 12px #b80f28;border-radius:50%}div#isso-thread a{border-bottom:none}</style><script async src="https://www.googletagmanager.com/gtag/js?id=UA-151172261-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-151172261-1');</script></head><body class=note><header class=masthead><div class=header><h1><a href=/>Bowser</a></h1><p class=tagline>Bowser&#39;s blog</p></div><nav class=menu><input id=menu-check type=checkbox>
<label id=menu-label for=menu-check class=unselectable><span class="icon close-icon">✕</span>
<span class="icon open-icon">☰</span>
<span class=text>MENU</span></label><ul><li><a href=/blog/>博客</a></li><li><a href=/note/>笔记</a></li><li><a href=/about/>关于</a></li><li><a href=/tags/>标签</a></li></ul></nav></header><article class=main><header class=title><h3 class=post-meta><span itemprop=articleSection class=category><a href=/categories/cs rel=category>cs</a></span>
/
<span itemprop=keywords class=tags><a href=/tags/csapp rel=tag>csapp</a></span></h3><h1>csapp UnixIO</h1><h3>Bowser
/ 2019-11-12</h3><hr></header><div class=container><h2 id=基本概念>基本概念</h2><p>首先要有一个思维，Linux上面基本上所有外部设备都是文件，都是通过IO来读取，写入的，包括键盘，网络，终端&hellip;..</p><p>P.S.：为什么终端是呢，想象一下以前大型计算机，只有一台主机，不同人使用，就是有多个终端(物理设备)来操作系统，只不过现在我们用的微机就是一台主机了。</p><p><img src=https://pic.superbed.cn/item/5dcabfbd8e0e2e3ee9b257f5.jpg alt=上一张图></p><p>看这张图片，可以看到：</p><ul><li>外设都是走I/O总线，从而与系统交互。</li></ul><h3 id=那怎么使用文件呢>那怎么使用文件呢</h3><p>一句话：系统打开文件时会生成两个结构一个是在系统表上，一个是在v-node表上。前者存储的是某个进程对文件读取的偏移量，后者储存的是文件的固有属性，文件大小，文件权限。</p><ul><li>文件读取的偏移量：你打开一个文件会进行读取，不可能一次读完，也不可能每次读都从头开始，而是记录你上次读到哪里了，这就是偏移量。</li></ul><p>对于某个进程来说：一个进程会打开多个文件，怎么管理呢？有一张表，叫做描述符表，每个打开的文件都有一个ID，也叫作描述符，你打开文件后，描述符就代表你的文件了。看下面的图</p><p><img src=https://pic.superbed.cn/item/5dcac3bc8e0e2e3ee9b6fc15.png alt></p><ul><li>子进程继承父进程的文件，有自己的描述符，但是指向相同的文件表。</li><li>一个进程打开两次同一个文件，会有两个描述符，但是同一个文件表结构。</li><li>文件表结构只有refcnt=0才会关闭，也就是引用他的文件描述符为0，才会关闭。</li></ul><p>P.S.：每个进程会默认打开三个文件，有三个描述符 0=标准输入(Stdin)，1=标准输出(Stdout)，2=标准错误(Stderr)</p><table><thead><tr><th align=center>整数值</th><th align=center>名称</th><th align=center>unistd.h符号常量[<a href=https://zh.wikipedia.org/wiki/文件描述符#cite_note-1>1]</a></th><th align=center>stdio.h文件流[<a href=https://zh.wikipedia.org/wiki/文件描述符#cite_note-2>2]</a></th></tr></thead><tbody><tr><td align=center>0</td><td align=center><a href=https://zh.wikipedia.org/wiki/Stdin>Standard input</a></td><td align=center>STDIN_FILENO</td><td align=center>stdin</td></tr><tr><td align=center>1</td><td align=center><a href=https://zh.wikipedia.org/wiki/Stdout>Standard output</a></td><td align=center>STDOUT_FILENO</td><td align=center>stdout</td></tr><tr><td align=center>2</td><td align=center><a href=https://zh.wikipedia.org/wiki/Stderr>Standard error</a></td><td align=center>STDERR_FILENO</td><td align=center>stderr</td></tr></tbody></table><h2 id=unix-io>Unix IO</h2><p>打开文件用到了open函数返回的是文件描述符，注意两个参数</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=kt>int</span> <span class=nf>open</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>filename</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>,</span> <span class=n>mode_t</span> <span class=n>mode</span><span class=p>);</span>
<span class=c1>//flags是进程如何访问这个文件，只读还是只写，或者不存在时新建
</span><span class=c1>//mode是创建文件时指定权限，就是正常的文件权限，读写执行，这里有一个umask，
</span><span class=c1>//每个进程都有一个umask，通过umask函数执行，真正的mode为 mode &amp; ~umask
</span><span class=c1>//出错返回-1 否则返回文件描述符
</span><span class=c1></span><span class=n>ssize_t</span> <span class=nf>read</span><span class=p>(</span><span class=kt>int</span> <span class=n>fd</span><span class=p>,</span> <span class=kt>void</span> <span class=o>*</span><span class=n>buf</span><span class=p>,</span> <span class=n>size_t</span> <span class=n>n</span><span class=p>);</span>
<span class=n>ssize_t</span> <span class=nf>write</span><span class=p>(</span><span class=kt>int</span> <span class=n>fd</span><span class=p>,</span> <span class=k>const</span> <span class=kt>void</span> <span class=o>*</span><span class=n>buf</span><span class=p>,</span> <span class=n>size_t</span> <span class=n>n</span><span class=p>);</span></code></pre></div><p>读和写文件，Unix IO读写文件都是无缓冲的，也就是说读文件，陷入内核态，按照指定的字节大小读取放到给定的字符指针内，如果遇到EOF就返回0，否则返回读取字节大小，出错返回-1，write就是过来。</p><ul><li>ssize_t与size_t，前者是signed，因为可能返回-1，后者是unsigned，读取字节数&gt;=0。</li><li>EOF，指的是当当前文件位置指向文件的最后，也就是文件偏移量等于文件长度时候，引发的end-of-file。并不实际存在这个东西。</li></ul><h2 id=rio与标准库io>RIO与标准库IO</h2><p>这些函数都是有缓冲的，怎么实现的呢，就是新建一个缓冲结构，每次调用Unix IO时尽可能的读取足够多的字节(等于缓冲区大小)，陷入内核态费时间，这样的话，如果下次再读，直接去缓冲区拿(空间换时间)。</p><p>RIO是对带缓冲io函数的实现，标准库io也是，还有格式化，但是也有很多问题，不适合在网络编程上使用，</p><p>这里就是一些函数，去看书，看具体实现。</p><h2 id=重定向>重定向</h2><p>Linux shell中的 <code>&gt;</code></p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh><span class=nv>$bowser</span>&gt; ls &gt; foo.txt</code></pre></div><p>dup2函数</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=kt>int</span> <span class=nf>dup2</span><span class=p>(</span><span class=kt>int</span> <span class=n>oldfd</span><span class=p>,</span> <span class=kt>int</span> <span class=n>newfd</span><span class=p>);</span>
<span class=c1>//如果newfd已经打开，会先关闭它。
</span><span class=c1>//一句话：把newtd指向oldfd的文件表项
</span><span class=c1></span><span class=n>dup</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
<span class=c1>//标准输入重定向到描述符5指向的文件表
</span><span class=c1></span><span class=o>//</span><span class=err>会继承</span><span class=mi>5</span><span class=err>打开文件的文件偏移量。因为指向的是同一个文件表。</span></code></pre></div><h2 id=疑问>疑问</h2><p>明确几点：</p><ol><li>带缓冲函数，就是新建立一个结构，储存了fd(文件描述符)，还有缓冲的字节数组，等等东西，代替fd来使用。</li><li>文件偏移量，也就是移动位置是放在文件表结构上的，这里有一个问题，似乎不能多个进程同时打开一个文件。</li><li>文件元数据(metadata)，文件大小，文件类型放在v-node表上。<ul><li>文件类型，文件中有一个type结构指定，例如文本文件，二进制文件，sockets文件。</li></ul></li><li>标准库IO是设计为读取文本文件的，所以其他类型文件不合适。</li></ol></div><hr></article><footer><nav class=post-nav><span class=nav-prev>&larr; <a href=/note/2019/11/01/%E5%88%A9%E7%94%A8systemd%E7%AE%A1%E7%90%86nginx.service/>利用systemd管理nginx.service</a></span>
<span class=nav-next></span></nav><script src=//yihui.name/js/math-code.js></script><script async src="//mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script><script async src=//yihui.name/js/center-img.js></script><div class=copyright>© 2019 Bowser - <strong><a href=https://creativecommons.org/licenses/by-nc/4.0/>CC BY-NC 4.0</a></strong> - <strong><a href=https://github.com/Bowser1704>Github</a></strong></div></footer></body></html>