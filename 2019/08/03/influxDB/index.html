<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>influxDB | Bowser&#39;s blog | 一切像你，一切像我</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="DB">
    <meta name="description" content="时序数据库influxDB初步使用">
<meta name="keywords" content="DB">
<meta property="og:type" content="article">
<meta property="og:title" content="influxDB">
<meta property="og:url" content="/2019/08/03/influxDB/index.html">
<meta property="og:site_name" content="Bowser&#39;s blog">
<meta property="og:description" content="时序数据库influxDB初步使用">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-08-03T09:39:13.920Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="influxDB">
<meta name="twitter:description" content="时序数据库influxDB初步使用">
    
        <link rel="alternate" type="application/atom+xml" title="Bowser&#39;s blog" href="/atom.xml">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="https://avatars2.githubusercontent.com/u/43539191?s=460&v=4" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpeg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">Bowser</h5>
          <a href="mailto:yuqlang@163.com" title="yuqlang@163.com" class="mail">yuqlang@163.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                Tags
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                Categories
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/Bowser1704" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="http://www.weibo.com/Bowser1704" target="_blank" >
                <i class="icon icon-lg icon-weibo"></i>
                Weibo
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://www.douban.com/people/153160581/"  >
                <i class="icon icon-lg icon-link"></i>
                豆瓣
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">influxDB</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">influxDB</h1>
        <h5 class="subtitle">
            
                <time datetime="2019-08-03T09:06:23.000Z" itemprop="datePublished" class="page-time">
  2019-08-03
</time>


            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-安装"><span class="post-toc-number">1.</span> <span class="post-toc-text">1. 安装</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-基本概念"><span class="post-toc-number">2.</span> <span class="post-toc-text">2. 基本概念</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-初次使用"><span class="post-toc-number">3.</span> <span class="post-toc-text">3. 初次使用</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#4-使用http接口CRUD"><span class="post-toc-number">4.</span> <span class="post-toc-text">4. 使用http接口CRUD</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#创建查询"><span class="post-toc-number">4.0.1.</span> <span class="post-toc-text">创建查询</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#查询"><span class="post-toc-number">4.0.2.</span> <span class="post-toc-text">查询</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#HTTP返回值"><span class="post-toc-number">4.0.3.</span> <span class="post-toc-text">HTTP返回值</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#5-HTTPS设置"><span class="post-toc-number">5.</span> <span class="post-toc-text">5. HTTPS设置</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#6-influxDB数据保留策略（Retention-Policies）"><span class="post-toc-number">6.</span> <span class="post-toc-text">6. influxDB数据保留策略（Retention Policies）</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#7-一些小问题"><span class="post-toc-number">7.</span> <span class="post-toc-text">7. 一些小问题</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#8-Influxsql"><span class="post-toc-number">8.</span> <span class="post-toc-text">8.Influxsql</span></a></li></ol>
        </nav>
    </aside>


<article id="post-influxDB"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">influxDB</h1>
        <div class="post-meta">
            <time class="post-time" title="2019-08-03 17:06:23" datetime="2019-08-03T09:06:23.000Z"  itemprop="datePublished">2019-08-03</time>

            


            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <p>时序数据库influxDB初步使用</p>
<a id="more"></a>

<h3 id="1-安装"><a href="#1-安装" class="headerlink" title="1. 安装"></a>1. 安装</h3><p>安装的时候去<a href="https://portal.influxdata.com/downloads/" target="_blank" rel="noopener">官网</a></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget http<span class="variable">s:</span>//<span class="keyword">dl</span>.influxdata.<span class="keyword">com</span>/influxdb/releases/influxdb_1.<span class="number">7.7</span>_amd64.<span class="keyword">deb</span></span><br><span class="line">#建议不要用wget，速度很慢，并且可能会和中断，用Aria2c！</span><br><span class="line">#  aria2c -s <span class="number">32</span> http<span class="variable">s:</span>//<span class="keyword">dl</span>.influxdata.<span class="keyword">com</span>/influxdb/releases/influxdb_1.<span class="number">7.7</span>_amd64.debsudo dpkg -i influxdb_1.<span class="number">7.7</span>_amd64.<span class="keyword">deb</span></span><br></pre></td></tr></table></figure>

<h3 id="2-基本概念"><a href="#2-基本概念" class="headerlink" title="2. 基本概念"></a>2. 基本概念</h3><p>示例数据</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">name: census</span><br><span class="line">-————————————</span><br><span class="line">time             butterflies     honeybees     <span class="keyword">location</span>   <span class="title">scientist</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center">名词</th>
<th align="center">解释</th>
<th align="center">举例</th>
</tr>
</thead>
<tbody><tr>
<td align="center">database</td>
<td align="center">数据库名字</td>
<td align="center">mydb</td>
</tr>
<tr>
<td align="center">measurement</td>
<td align="center">类似于sql中的table</td>
<td align="center">census</td>
</tr>
<tr>
<td align="center">field key</td>
<td align="center">字段的键</td>
<td align="center">butterflies</td>
</tr>
<tr>
<td align="center">tag key</td>
<td align="center">tag区别于field可以用来索引，后者是存储的数据，tag是帮助查询的</td>
<td align="center">location</td>
</tr>
<tr>
<td align="center">value</td>
<td align="center">上面两个key的value</td>
<td align="center">12</td>
</tr>
<tr>
<td align="center">retention policy</td>
<td align="center">储存策略</td>
<td align="center">autogen</td>
</tr>
<tr>
<td align="center">tag set</td>
<td align="center">相同tag的集合</td>
<td align="center">location = 1, scientist = langstroth location = 2, scientist = langstroth两组</td>
</tr>
<tr>
<td align="center">field set</td>
<td align="center">相同的field的集合</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">series</td>
<td align="center">series是相同retention policy，measurement和tag set的集合。</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">point</td>
<td align="center">point指具有相同timestamp的相同series的filed的集合</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
</tbody></table>
<h3 id="3-初次使用"><a href="#3-初次使用" class="headerlink" title="3. 初次使用"></a>3. 初次使用</h3><p>我们使用<code>influxDB</code>自带的influx工具与DB通信，也是cs架构。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">sudo</span> <span class="selector-tag">systemctl</span> <span class="selector-tag">start</span> <span class="selector-tag">influxdb</span><span class="selector-class">.service</span></span><br><span class="line">#开启<span class="selector-tag">influxDB</span>服务，可以多尝试使用<span class="selector-tag">systemctl</span>命令来进行服务的关闭开启</span><br><span class="line"><span class="selector-id">#sudo</span> <span class="selector-tag">systemctl</span> <span class="selector-tag">stop</span> <span class="selector-tag">influxdb</span><span class="selector-class">.service</span>就是关闭服务<span class="selector-tag">influx</span> <span class="selector-tag">-precision</span> <span class="selector-tag">rfc3339</span></span><br><span class="line"><span class="selector-id">#precision</span>的意思是选择返回时间戳的格式和精度<span class="selector-id">#rfc3339</span>是返回<span class="selector-tag">RFC339</span>格式(<span class="selector-tag">YYYY-MM-DDTHH</span><span class="selector-pseudo">:MM</span><span class="selector-pseudo">:SS.nnnnnnnnnZ)</span>的时间戳。</span><br></pre></td></tr></table></figure>

<p>然后我们就进入了类似于其他DB的CRUD环境，使用<code>exit</code>可以退出到终端</p>
<p>CRUD</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; CREATE DATABASE mydb#创建一个名字为mydb的数据库#如果没有返回信息说明没有问题，没有消息就是好消息</span><br><span class="line">INSERT cpu,<span class="attribute">host</span>=serverA, <span class="attribute">region</span>=us, <span class="attribute">value</span>=64#插入一条数据，measurement是cpu(类似于sql中的table)，tag-value有三对SELECT <span class="string">"host"</span>, <span class="string">"region"</span>, <span class="string">"value"</span> <span class="keyword">FROM</span> <span class="string">"cpu"</span></span><br><span class="line"><span class="comment">#应为influxDB默认使用UTC时区，但是我们是UTC+8，所以有两种解决方法#查出来数据之后加8使用#tz命令，选择时区，查询的就是上海/中国时区。</span></span><br><span class="line">SELECT <span class="string">"host"</span>, <span class="string">"region"</span>, <span class="string">"value"</span> <span class="keyword">FROM</span> <span class="string">"cpu"</span>tz(<span class="string">"Asia/Shanghai"</span>)</span><br></pre></td></tr></table></figure>

<h3 id="4-使用http接口CRUD"><a href="#4-使用http接口CRUD" class="headerlink" title="4. 使用http接口CRUD"></a>4. 使用<code>http</code>接口CRUD</h3><h5 id="创建查询"><a href="#创建查询" class="headerlink" title="创建查询"></a>创建查询</h5><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">posthttp://localhos<span class="variable">t:8086</span>/queryHeader<span class="variable">s:</span> Content-Type:application/<span class="keyword">x</span>-www-form-urlencodedBody: q:CREATE DATABSE testdb #就是创建一个数据库testdb</span><br><span class="line">posthttp://localhos<span class="variable">t:8086</span>/<span class="keyword">write</span>?db=mydb#dat<span class="variable">a:</span> binary格式body: <span class="string">'cpu_load_short,host=server01,region=us-west value=0.64 1434055562000000000'</span>的二进制文件格式</span><br></pre></td></tr></table></figure>

<p>可以利用<code>crul</code></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -<span class="selector-tag">i</span> -XPOST http:<span class="comment">//localhost:8086/query --data-urlencode "q=CREATE DATABASE mydb"</span></span><br><span class="line">#创建数据库curl -<span class="selector-tag">i</span> -XPOST <span class="string">'http://localhost:8086/write?db=mydb'</span> --data-binary <span class="string">'cpu_load_short,host=server01,region=us-west value=0.64 1434055562000000000'</span></span><br><span class="line">#写入数据到mydb，最后面的是时间戳即自定义时间，注意依旧是UTC时间格式curl -<span class="selector-tag">i</span> -XPOST <span class="string">'http://localhost:8086/write?db=mydb'</span> --data-binary <span class="string">'cpu_load_short,host=server02 value=0.67 cpu_load_short,host=server02,region=us-west value=0.55 1422568543702900257  cpu_load_short,direction=in,host=server01,region=us-west value=2.0 1422568543702900257'</span></span><br><span class="line">#同时写入多个数据curl -<span class="selector-tag">i</span> -XPOST <span class="string">'http://localhost:8086/write?db=mydb'</span> --data-binary @cpu_data.txt</span><br><span class="line">#写入文件中的数据，文件格式必须如下</span><br><span class="line"><span class="selector-id">#cpu_load_short</span>,host=server02 value=<span class="number">0.67</span></span><br><span class="line"><span class="selector-id">#cpu_load_short</span>,host=server02,region=us-west value=<span class="number">0.55</span> <span class="number">1422568543702900257</span></span><br><span class="line"><span class="selector-id">#cpu_load_short</span>,<span class="attribute">direction</span>=in,host=server01,region=us-west value=<span class="number">2.0</span> <span class="number">1422568543702900257</span></span><br></pre></td></tr></table></figure>

<h5 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h5><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GEThttp://localhost:<span class="number">8086</span>/query?pretty=<span class="literal">true</span><span class="meta">#pretty=true是为了使输出json格式化Headers: Content-Type:application/x-www-form-urlencodedBody: <span class="string">"db=mydb"</span>, <span class="string">"q=SELECT \"</span>value\<span class="string">" FROM \"</span>cpu_load_short\<span class="string">" WHERE \"</span>region\<span class="string">"='us-west'"</span>#注意这里的转义字符#返回的是json值</span></span><br><span class="line">curl -G <span class="string">'http://localhost:8086/query?pretty=true'</span> --data-urlencode <span class="string">"db=mydb"</span> --data-urlencode <span class="string">"q=SELECT \"</span>value\<span class="string">" FROM \"</span>cpu_load_short\<span class="string">" WHERE \"</span>region\<span class="string">"='us-west'"</span><span class="meta">#查找serious为<span class="string">"cpu_load_short"</span>,<span class="string">"region"</span>=<span class="string">"us-west"</span>的value</span></span><br></pre></td></tr></table></figure>

<p>查询可选参数</p>
<ul>
<li><p>时间戳格式epoch 可选[h,m,s,ms,u,ns]的其中一个</p>
<figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">curl </span>-G <span class="string">'http://localhost:8086/query'</span> <span class="built_in">--data-urlencode</span> <span class="string">"db=mydb"</span> <span class="built_in">--data-urlencode</span> <span class="string">"epoch=s"</span> <span class="built_in">--data-urlencode</span> <span class="string">"q=SELECT \"</span><span class="string">value\</span><span class="string">" FROM \"</span><span class="string">cpu_load_short\</span><span class="string">" WHERE \"</span><span class="string">region\</span><span class="string">"='us-west'"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>…….</p>
</li>
</ul>
<h5 id="HTTP返回值"><a href="#HTTP返回值" class="headerlink" title="HTTP返回值"></a>HTTP返回值</h5><ul>
<li>2xx：如果返回<code>HTTP 204 No Content</code>，那就操作成功</li>
<li>4xx: 表示不能识别请求</li>
<li>5xx： 系统过载，或者是应用受损</li>
</ul>
<h3 id="5-HTTPS设置"><a href="#5-HTTPS设置" class="headerlink" title="5. HTTPS设置"></a>5. <code>HTTPS</code>设置</h3><ol>
<li><p>安装<code>SSL</code>/<code>TLS</code>证书</p>
<p>将私钥文件（.key）和签名的证书文件（<code>.crt</code>）或单个捆绑文件（<code>.pem</code>）放在<code>/etc/ssl</code>目录中。</p>
</li>
<li><p>确保文件权限</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chown root:root <span class="meta-keyword">/etc/</span>ssl/<span class="params">&lt;CA-certificate-file&gt;</span>sudo chmod <span class="number">644</span> <span class="meta-keyword">/etc/</span>ssl/<span class="params">&lt;CA-certificate-file&gt;</span>sudo chmod <span class="number">600</span> <span class="meta-keyword">/etc/</span>ssl/<span class="params">&lt;private-key-file&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在<code>influxDB</code>设置中打开</p>
<p>默认<code>HTTPS</code>是关闭的，在<code>InfluxDB</code>的配置文件<code>/etc/influxdb/influxdb.conf</code>的<code>[http]</code>部分通过如下设置开启<code>HTTPS</code>：</p>
<ul>
<li><code>https-enabled</code>设为true</li>
<li>http-certificate设为/etc/ssl/.crt(或者/etc/ssl/.pem)</li>
<li>http-private-key设为/etc/ssl/.key(或者/etc/ssl/.pem)</li>
</ul>
</li>
<li><p>重启influxDB</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sudo systemctl restart influxdb</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>验证</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">influx</span> <span class="selector-tag">-ssl</span> <span class="selector-tag">-host</span> <span class="selector-tag">localhost</span><span class="selector-class">.com</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="6-influxDB数据保留策略（Retention-Policies）"><a href="#6-influxDB数据保留策略（Retention-Policies）" class="headerlink" title="6. influxDB数据保留策略（Retention Policies）"></a>6. <code>influxDB</code>数据保留策略（Retention Policies）</h3><p>influxDB每秒可以处理成千上万条数据，要将这些数据全部保存下来会占用大量的存储空间，有时我们可能并不需要将所有历史数据进行存储，因此，InfluxDB推出了数据保留策略（Retention Policies），用来让我们自定义数据的保留时间。<br>InfluxDB的数据保留策略（RP） 用来定义数据在InfluxDB中存放的时间，或者定义保存某个期间的数据。<br>一个数据库可以有多个保留策略，但每个策略必须是独一无二的。</p>
<ol>
<li><p>查询某数据库的policies</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;  SHOW RETENTION POLICIES mydbname    duration shardGroupDuration replicaN default<span class="params">----</span>          <span class="params">--------</span>       <span class="params">------------------</span>               <span class="params">--------</span>       <span class="params">-------autogen</span> 0s            168h0m0s                       1                <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>数据库mydb只有一个策略，名字是<code>autogen</code>，各字段解释</p>
<ul>
<li>name：名称，此示例名称为 autogen。当你创建一个数据库的时候，InfluxDB会自动为数据库创建一个名叫 autogen 的策略，这个策略会永久保存数据。你可以重命名这个策略，并且在InfluxDB的配置文件中禁止掉自动创建策略。</li>
<li>duration：数据保存时间，0代表无限制</li>
<li>shardGroupDuration：shardGroup的存储时间，shardGroup是InfluxDB的一个基本储存结构。</li>
<li>replicaN：全称是REPLICATION，副本个数</li>
<li>default：是否是默认策略。</li>
</ul>
</li>
<li><p>两个概念</p>
<ul>
<li><p>shard</p>
<p>shard 在 InfluxDB 中是一个比较重要的概念，它和 retention policy 相关联。每一个存储策略下会存在许多 shard，每一个 shard 存储一个指定时间段内的数据，并且不重复，例如 7点-8点 的数据落入 shard0 中，8点-9点的数据则落入 shard1 中。</p>
<p>创建数据库时会自动创建一个默认存储策略，永久保存数据，对应的在此存储策略下的 shard 所保存的数据的时间段为 7 天，也就是上面查询时看到的168h。计算的函数如下</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func shardGroupDuration(d <span class="built_in">time</span>.Duration) <span class="built_in">time</span>.Duration &#123;    <span class="keyword">if</span> d &gt;= <span class="number">180</span>*<span class="number">24</span>*<span class="built_in">time</span>.Hour |<span class="type">| d</span> == <span class="number">0</span> &#123; // <span class="number">6</span> months or <span class="number">0</span>        <span class="keyword">return</span> <span class="number">7</span> * <span class="number">24</span> * <span class="built_in">time</span>.Hour    &#125; <span class="keyword">else</span> <span class="keyword">if</span> d &gt;= <span class="number">2</span>*<span class="number">24</span>*<span class="built_in">time</span>.Hour &#123; // <span class="number">2</span> days        <span class="keyword">return</span> <span class="number">1</span> * <span class="number">24</span> * <span class="built_in">time</span>.Hour    &#125;    <span class="keyword">return</span> <span class="number">1</span> * <span class="built_in">time</span>.Hour&#125;</span><br></pre></td></tr></table></figure>

<p>如果创建一个新的 retention policy 设置数据的保留时间为 1 天，则单个 shard 所存储数据的时间间隔为 1 小时，超过1个小时的数据会被存放到下一个 shard 中。</p>
</li>
<li><p>shard group</p>
<p>shard group是shards的逻辑容器</p>
</li>
</ul>
</li>
<li><p>创建策略</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE RETENTION<span class="built_in"> POLICY </span>&lt;retention_policy_name&gt; ON &lt;database_name&gt; DURATION &lt;duration&gt; REPLICATION &lt;n&gt; [SHARD DURATION &lt;duration&gt;] [DEFAULT]</span><br></pre></td></tr></table></figure>

<p>其中：SHARD DURATION子句决定了每个shard group存储的时间间隔，在永久存储的策略里这个子句是无效的。这个子句是可选的。shard group duration默认由策略的 duration 决定。<code>上面的函数</code></p>
<p>| Retention Policy’s DURATION | Shard Group Duration |<br>| :————————-: | :——————: |<br>| &lt;2 1 days | hour&gt;= 2 days &amp;&amp; &lt;= 6 months | 1 day |<br>| &gt; 6 months | 7 days |<br>| | |</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CREATE RETENTION<span class="built_in"> POLICY </span><span class="string">"one_day_only"</span> ON <span class="string">"mydb"</span> DURATION 1d REPLICATION </span><br><span class="line"><span class="comment">#创建策略</span></span><br><span class="line">CREATE RETENTION<span class="built_in"> POLICY </span><span class="string">"one_day_only"</span> ON <span class="string">"mydb"</span> DURATION 23h60m REPLICATION 1 DEFAULT</span><br><span class="line"><span class="comment">#创建默认策略</span></span><br><span class="line">ALTER RETENTION<span class="built_in"> POLICY </span>&lt;retention_policy_name&gt; ON &lt;database_name&gt; DURATION &lt;duration&gt; REPLICATION &lt;n&gt; SHARD DURATION &lt;duration&gt; DEFAULT</span><br><span class="line"><span class="comment">#修改策略</span></span><br><span class="line">DROP RETENTION<span class="built_in"> POLICY </span>&lt;retention_policy_name&gt; ON &lt;database_name&gt;</span><br><span class="line"><span class="comment">#删除策略</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="7-一些小问题"><a href="#7-一些小问题" class="headerlink" title="7. 一些小问题"></a>7. 一些小问题</h3><ol>
<li>有些时候where语句值必须用 ‘’,不可以用””</li>
</ol>
<h3 id="8-Influxsql"><a href="#8-Influxsql" class="headerlink" title="8.Influxsql"></a>8.<code>Influxsql</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SELECT COUNT(*) FROM &quot;insight&quot;.&quot;autogen&quot;.&quot;data1&quot; WHERE time &gt; 1564416000/timestamp AND &quot;mianCat&quot;=&apos;pageView&apos; AND &quot;pid&quot;=&apos;ccnubox&apos; </span><br><span class="line">#返回某时间之后的所有页面的PV</span><br><span class="line">SELECT COUNT(*) FROM &quot;insight&quot;.&quot;autogen&quot;.&quot;data1&quot; WHERE time &gt; 1564416000 AND &quot;mianCat&quot;=&apos;pageView&apos; AND &quot;pid&quot;=&apos;ccnubox&apos; AND &quot;subCat&quot;=&apos;com.muxistudio.grade.main&apos;</span><br><span class="line">#返回某时间之后的成绩请求页面PV</span><br><span class="line">SELECT COUNT(*) FROM &quot;insight&quot;.&quot;autogen&quot;.&quot;data1&quot; WHERE time &gt; 1564416000 AND &quot;mianCat&quot;=&apos;pageView&apos; AND &quot;pid&quot;=&apos;ccnubox&apos; AND &quot;subCat&quot;=&apos;com.muxistudio.course.main&apos;</span><br><span class="line">#返回某时间之后的课程请求页面PV</span><br><span class="line">SELECT COUNT(*) FROM &quot;insight&quot;.&quot;autogen&quot;.&quot;data1&quot; WHERE time &gt; 1564416000 AND &quot;mianCat&quot;=&apos;pageView&apos; AND &quot;pid&quot;=&apos;ccnubox&apos; GROUP BY subCat</span><br></pre></td></tr></table></figure>
        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2019-08-03T09:39:13.920Z" itemprop="dateUpdated">2019-08-03 17:39:13</time>
</span><br>


        
        <a href="/2019/08/03/influxDB/" target="_blank" rel="external">/2019/08/03/influxDB/</a>
        
    </div>
    
    <footer>
        <a href="">
            <img src="/img/avatar.jpeg" alt="Bowser">
            Bowser
        </a>
    </footer>
</blockquote>

        


        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DB/">DB</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=/2019/08/03/influxDB/&title=《influxDB》 — Bowser's blog&pic=/img/avatar.jpeg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=/2019/08/03/influxDB/&title=《influxDB》 — Bowser's blog&source=时序数据库influxDB初步使用" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=/2019/08/03/influxDB/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《influxDB》 — Bowser's blog&url=/2019/08/03/influxDB/&via=" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=/2019/08/03/influxDB/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2019/08/03/unixIO/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">unix中一些io基础</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2019/08/03/simply-using-git/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">simply-using-git</h4>
      </a>
    </div>
  
</nav>



    




















</article>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>博客内容遵循 <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p><span>Bowser &copy; 2019</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=/2019/08/03/influxDB/&title=《influxDB》 — Bowser's blog&pic=/img/avatar.jpeg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=/2019/08/03/influxDB/&title=《influxDB》 — Bowser's blog&source=时序数据库influxDB初步使用" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=/2019/08/03/influxDB/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《influxDB》 — Bowser's blog&url=/2019/08/03/influxDB/&via=" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=/2019/08/03/influxDB/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="//api.qrserver.com/v1/create-qr-code/?data=/2019/08/03/influxDB/" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: false };


</script>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/main.min.js"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/search.min.js" async></script>






<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<script>
(function() {
    var OriginTitile = document.title, titleTime;
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            document.title = '死鬼去哪里了！';
            clearTimeout(titleTime);
        } else {
            document.title = '(つェ⊂)咦!又好了!';
            titleTime = setTimeout(function() {
                document.title = OriginTitile;
            },2000);
        }
    });
})();
</script>



</body>
</html>
